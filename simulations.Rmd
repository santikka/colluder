---
title: "Full Law Identification under Missing Data in the Categorical Colluder Model: Simulation Experiments"
output: html_document
date: "2024-04-02"
---

```{r setup, include=FALSE}
set.seed(1)
knitr::opts_chunk$set(echo = TRUE)
suppressPackageStartupMessages(library("dplyr"))
```

We study the validity of identification of the full law using Theorem 1 via simulations in the examples of the paper. First, we define a general estimator function that solves the colluder equations to estimate $P(R_Y = 1|X^{(1)} = x_j, R_X = 0)$ for all values $x_j$ of $X^{(1)}$:

```{r est}
estfun <- function(d) {
  xmargin <- prop.table(table(subset(d, rx == 1)$x))
  ycondx <- t(prop.table(table(subset(d, rx == 1 & ry == 1, select = c(x, y))), margin = 1))
  A <- tcrossprod(rep(1, nrow(ycondx)), xmargin) * ycondx * mean(d$rx == 0)
  b <- table(subset(d, rx == 0 & ry == 1)$y) / nrow(d)
  if (nrow(A) > ncol(A)) {
    # Here we have multiple ways to estimate, we compute all estimates
    idx <- seq_len(nrow(A))
    tmp <- expand.grid(a = idx, b = idx)
    tmp <- tmp[tmp$a < tmp$b, ]
    rycondx_est <- vector(mode = "list", length = nrow(A))
    for (i in idx) {
      j <- c(tmp$a[i], tmp$b[i])
      rycondx_est[[i]] <- solve(A[j, ], b[j])
    }
  } else {
    rycondx_est <- solve(A, b)
  }
  rycondx_true <- prop.table(table(subset(d, rx == 0, select = c(x, ry))), margin = 1)[, 2]
  list(rycondx_true = rycondx_true, rycondx_est = rycondx_est)
}
```

### Figure 1 (b) with Binary $X$ and Binary $Y$

The model is
$$
  \begin{aligned}
    U_X &\sim U(0,1) \\
    U_Y &\sim U(0,1) \\
    U_{R_X} &\sim U(0,1) \\
    U_{R_Y} &\sim U(0,1) \\
    X^{(1)} &= I(U_X > 0.25) \\
    Y^{(1)} &= I(U_Y < 0.1 + 0.6 \cdot I(X^{(1)} = 1)) \\
    R_X &= I(U_{R_X} < 0.4) \\
    R_Y &= I(U_{R_Y} < 0.3 \cdot I(X = 1 \wedge R_X = 0) + 0.5 \cdot R_X + 0.1) \\
  \end{aligned}
$$

```{r fig1b_binxy}
n <- 1000000
ux <- runif(n)
uy <- runif(n)
urx <- runif(n)
ury <- runif(n)
x <- 1 * (ux > 0.25)
y <- 1 * (uy < 0.1 + 0.6 * (x == 1))
rx <- 1 * (urx < 0.4)
ry <- 1 * (ury < 0.3 * (x == 1 & rx == 0) + 0.5 * rx + 0.1)
d1 <- data.frame(x = x, y = y, rx = rx, ry = ry)
out1 <- estfun(d1)
# True probabilities
out1$rycondx_true
# Estimated probabilities
out1$rycondx_est
```

### Figure 1 (b) with Binary $X$ and Ternary $Y$

The model is
$$
  \begin{aligned}
    U_X &\sim U(0,1) \\
    U_Y &\sim U(0,1) \\
    U_{R_X} &\sim U(0,1) \\
    U_{R_Y} &\sim U(0,1) \\
    X^{(1)} &= I(U_X > 0.25) \\
    Y^{(1)} &= \text{sign}(U_Y - 0.2 - 0.2 \cdot |X^{(1)}|) \cdot I(U_Y < 0.1 + 0.3 \cdot I(X^{(1)} = 0) + 0.5 \cdot I(X = 1)) \\
    R_X &= I(U_{R_X} < 0.5) \\
    R_Y &= I(U_{R_Y} < 0.3 \cdot I(X = 1 \wedge R_X = 0) + 0.6 \cdot I(X^{(1)} = -1 \wedge R_X = 0) + 0.5 \cdot R_X + 0.1) \\
  \end{aligned}
$$

```{r fig1b_binx_terny}
n <- 1000000
ux <- runif(n)
uy <- runif(n)
urx <- runif(n)
ury <- runif(n)
x <- 1 * (ux > 0.4)
y <- sign(uy - 0.2 - 0.2 * abs(x)) * (uy < 0.1 + 0.3 * (x == 0) + 0.6 * (x == 1))
rx <- 1 * (urx < 0.5)
ry <- 1 * (ury < 0.3 * (x == 1 & rx == 0)  + 0.6 * (x == -1 & rx == 0) + 0.5 * rx + 0.1)
d2 <- data.frame(x = x, y = y, rx = rx, ry = ry)
out2 <- estfun(d2)
# True probabilities
out2$rycondx_true
# Estimated probabilities
# (Note, multiple estimates in this case)
out2$rycondx_est
```

### Figure 1 (b) with Ternary $X$ and Ternary $Y$

The model is
$$
  \begin{aligned}
    U_X &\sim U(0,1) \\
    U_Y &\sim U(0,1) \\
    U_{R_X} &\sim U(0,1) \\
    U_{R_Y} &\sim U(0,1) \\
    X^{(1)} &= \lfloor 0.5 + 2(U_X - 0.5) \rfloor \\
    Y^{(1)} &= \text{sign}(U_Y - 0.2 - 0.2 \cdot |X^{(1)}|) \cdot I(U_Y < 0.1 + 0.2 \cdot I(X^{(1)} = -1) + 0.3 \cdot I(X^{(1)} = 0) +  0.6 \cdot I(X = 1)) \\
    R_X &= I(U_{R_X} < 0.5) \\
    R_Y &= I(U_{R_Y} < 0.3 \cdot I(X = 1 \wedge R_X = 0) + 0.6 \cdot I(X^{(1)} = -1 \wedge R_X = 0) + 0.5 \cdot R_X + 0.1) \\
  \end{aligned}
$$

```{r fig1b_ternxy}
n <- 1000000
ux <- runif(n)
uy <- runif(n)
urx <- runif(n)
ury <- runif(n)
x <- floor(0.5 + 2 * (ux - 0.5))
y <- sign(uy - 0.2 - 0.2 * abs(x)) * (uy < 0.1 + 0.2 * (x == -1) + 0.3 * (x == 0) + 0.6 * (x == 1))
rx <- 1 * (urx < 0.5)
ry <- 1 * (ury < 0.3 * (x == 1 & rx == 0)  + 0.6 * (x == -1 & rx == 0)  + 0.5 * rx + 0.1)
d3 <- data.frame(x = x, y = y, rx = rx, ry = ry)
out3 <- estfun(d3)
# True probabilities
out3$rycondx_true
# Estimated probabilities
out3$rycondx_est
```
### Figure 2 (a) with Ternary $X$ and Ternary $Y$

The model is
$$
  \begin{aligned}
    U_X &\sim U(0,1) \\
    U_Y &\sim U(0,1) \\
    U_{X,Y} &\sim U(0,1) \\
    U_{R_X} &\sim U(0,1) \\
    U_{R_Y} &\sim U(0,1) \\
    U_{R_Y,R_Y} &\sim U(0,1) \\
    X^{(1)} &= \lfloor 0.5 + 2(0.7 \cdot U_X + 0.3 \cdot U_{XY}) \rfloor \\
    Y^{(1)} &= \text{sign}(U_Y - 0.2 - 0.2 \cdot |X^{(1)}|) \cdot I(U_{X,Y} < 0.1 + 0.2 \cdot I(X^{(1)} = -1) + 0.3 \cdot I(X^{(1)} = 0) +  0.6 \cdot I(X = 1)) \\
    R_X &= I(0.8 \cdot U_{R_X} + 0.2 \cdot U_{R_X,R_Y} < 0.5) \\
    R_Y &= I(0.9 \cdot U_{R_Y} + 0.1 \cdot U_{R_X,R_Y} < 0.3 \cdot I(X = 1 \wedge R_X = 0) + 0.6 \cdot I(X^{(1)} = -1 \wedge R_X = 0) + 0.5 \cdot R_X + 0.1) \\
  \end{aligned}
$$

```{r fig2a_ternxy}
n <- 1000000
ux <- runif(n)
uy <- runif(n)
uxy <- runif(n)
urx <- runif(n)
urxry <- runif(n)
x <- floor(0.5 + 2 * (0.7 * ux + 0.3 * uxy - 0.5))
y <- sign(uy - 0.2 - 0.2 * abs(x)) * (uxy < 0.1 + 0.2 * (x == -1) + 0.3 * (x == 0) + 0.6 * (x == 1))
rx <- 1 * (0.8 * urx + 0.2 * urxry < 0.5)
ry <- 1 * (0.9 * ury + 0.1 * urxry < 0.3 * (x == 1 & rx == 0) + 0.6 * (x == -1 & rx == 0) + 0.5 * rx + 0.1)
d4 <- data.frame(x = x, y = y, rx = rx, ry = ry)
out4 <- estfun(d4)
out4$rycondx_true
out4$rycondx_est
```


### Figure 2 (b) with Binary $X$ and Binary $Y$

The model is
$$
  \begin{aligned}
    U_X &\sim U(0,1) \\
    U_Y &\sim U(0,1) \\
    U_{R_X} &\sim U(0,1) \\
    U_{R_Y} &\sim U(0,1) \\
    U_{X, R_Y} &\sim U(0,1) \\
    U_{R_Y,R_Y} &\sim U(0,1) \\
    X^{(1)} &= I(0.6 \cdot U_X + 0.4 \cdot U_{X,R_Y} > 0.3) \\
    Y^{(1)} &= I(U_Y < 0.1 + 0.6 \cdot I(X^{(1)} = 1)) \\
    R_X &= I(0.8 \cdot U_{R_X} + 0.2 \cdot U_{R_X,R_Y} < 0.6) \\
    R_Y &= I(0.5 \cdot U_{R_Y} + 0.3 \cdot U_{X,R_Y} + 0.2 \cdot U_{R_X,R_Y} < 0.3 \cdot I(X = 1 \wedge R_X = 0) + 0.5 \cdot R_X + 0.1) \\
  \end{aligned}
$$

```{r fig2b_binxy}
n <- 1000000
ux <- runif(n)
uy <- runif(n)
urx <- runif(n)
ury <- runif(n)
uxry <- runif(n)
urxry  <- runif(n)
x <- 1 * (0.6 * ux + 0.4 * uxry > 0.3)
y <- 1 * (uy < 0.1 + 0.6 * (x == 1))
rx <- 1 * (0.8 * urx + 0.2 * urxry < 0.5)
ry <- 1 * (0.5 * ury + 0.3 * uxry + 0.2 * urxry < 0.3 * (x == 1 & rx == 0) + 0.5 * rx + 0.1)
d5 <- data.frame(x = x, y = y, rx = rx, ry = ry)
out5 <- estfun(d5)
# True probabilities
out5$rycondx_true
# Estimated probabilities
out5$rycondx_est
```
